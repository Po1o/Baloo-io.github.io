---
layout: post
title: "Linux Desktop"
description: "Has the Linux Desktop finally happened?"
category: articles
tags: [chrome OS]
comments: true
image: assets/images/chromeos.jpg
---

For years, I have been hearing that "this year is the Linux Dekstop year". And while Linux has gained traction - it is ubiquitous on servers and all Android phones are running Linux - it still has to make progress on the desktop. Yet, the situation on the desktop is not bad. Over the years, Gnome, KDE and the likes have dramatically improved and now provide an enjoyable experience. But Linux is still very marginally used on desktop. Or so I thought...

A few months ago, my Macbook started to show its age and needed a replacement. But there were growing rumors that Apple was about to switch to their own chip. (It turned out this was true). I felt that buying on an Intel-based Macbook that would soon become obsolete would not be a good investment. So I started to look for something that would fit my needs at a reasonable cost.

Now, before we go further let me explain what I usually do on my personal machine: I browse the web, listen to music, take notes, occasionally watch a movie and other than that I spend my time in a terminal. On my mac, [homebrew](https://brew.sh/) is usually the first thing I install and then I use the same tools than on Linux. I really like MacOS because it is a UNIX system - actually even POSIX-certified. It's a great system for development and it has a nice UI and lots of apps too.

The possible alternatives for me were Windows with the [Windows Subsystem for Linux](https://en.wikipedia.org/wiki/Windows_Subsystem_for_Linux) or, of course, Linux. I haven't used recent versions of Windows, the last one I used was Windows 7 - it was pretty good but not POSIX - and I never coded on Windows, just used it for productivity suite. On the other hand, I have a Linux machine, a 3-year old laptop running Arch Linux that I use to tinker a bit. As much as I enjoy Linux, I did not feel like using this setup for when I am casually browsing the web on the couch after diner - I run [Sway](https://swaywm.org/) on this system, so it is tailored for work and development, but anyway, that's all I had. That's about when a colleague told me I should look at Chromebooks.

I did not know much about ChromeOS. The only thing I knew about it was what I heard when it launched: it is a Linux that boots to Chrome. I always considered ChromeOS was a niche Operating System with very limited capabilities. But my colleague, a great developer and a very technical person, could not stop telling me how much he enjoyed his Pixelbook. So I was curious and started to look for more information.

What I found out left me astonished. The Linux Desktop had happened right before my eyes and I hadn't noticed. And it looked a lot different than what I had expected. I had been really biased by the fact that Chromebooks are usually entry-level, cheap, under-powered machines so I still had the misconception that Chromebooks just run Chrome. However, after reading a bit about ChromeOS, I realized how much it had evolved. 

One of the reasons is not directly linked to ChromeOS itself but more to the fact that web-apps and now also progressive web-apps (PWA) have insanely improved the user experience and can really look and feel like native apps (Ex: Google Drive, Twitter, Starbucks...). And ChromeOS takes advantage of this. It is easy to "install" these apps: you can create a shortcut to run the app in their own window (and without the URL bar) or in the case of PWA you even get an install button. Notifications work the way you expect. It feels like a "normal" app. (Note: This by the way is also possible on other OS using Chrome. I use that on MacOS.)

!["Progressive web-app"]({{ site.url }}/assets/images/chromeos-pwa.jpg)
*Progressive web-app*

Another reason is that Android Apps are now supported on ChromeOS. This is done through ARC++ (Android Runtime for Chrome). At a high-level, the Android framework is running inside a container on ChromeOS which is possible because Android is also running on Linux as is ChromeOS and the apps are run from this container. There are [quite some technical problems to solve](https://lwn.net/Articles/701964/) for rendering the display with the ChromeOS compositor. The Android framework is running in a container for security reasons, in an effort to isolate the Android Apps from ChromeOS for security reasons. This works really well even though the ChromeOS support in Android apps will vary a bit from apps to apps. But ChromeOS is definitely [one of the platform](https://developer.android.com/chrome-os/intro) that Android developers can target along Wear OS, Android TV and Android for Cars. Some Android apps really feel at home on ChromeOS and proves the Android SDK is the way to develop "native" apps for the platform. Lightroom is one such app. For most users, running Android apps is a key feature and let's hope more and more developers will develop apps for ChromeOS.

!["Android app"]({{ site.url }}/assets/images/chromeos-android.jpg)
*Android app*

This is nice and makes ChromeOS interesting but what piqued my curiosity was the Linux support, called Linux (Beta). Initially, I thought it was about providing access to the underlying Linux system but it is in fact a bit more complicated than that. One of the key philosophy in ChromeOS is security. Most of what runs on the system is containerized and isolated from each other. And Linux is no exception but they went a bit further: Linux is actually running on top of a VM, and that VM is read-only. Its only-purpose is to run Linux containers (LXD) which have read-write access. When you turn on the Linux (Beta) feature, the OS is going to download a couple of images, started the VM and then the default container - a Debian 10 - inside the VM. So far, nothing really new and it even seems a bit convoluted since ChromeOS is running Linux. So why all the hoops?

Security is the main reason. From the user perspective, ChromeOS is fairly immutable. You cannot really access the system files, you don't see any of the underlying intricacies. You can still use the local disk to store files but only in the "My Files" section which, with Google Drive, are the only two storages visible in the file manager. There is a shell for ChromeOS but it is not a standard one. Its name is crosh and it gives you access to a limited set of functionalities. In other words, ChromeOS is secured and all is designed to run sandboxed either through containers or VMs.

Linux is running in a VM (and in a container), so what? What is really interesting is the level of integration they have achieved between the Linux container in the VM and ChromeOS. Applications with a GUI that are installed within the Linux container using the standard "apt install" (remember, it is a Debian) automatically appears in the ChromeOS launcher. When you use them, from a UX perspective, it feels native to ChromeOS. You don't know it is running from the container. The wayland compositor from ChromeOS is used to composite windows from chromeOS and the ones from the Linux container, thanks to a wayland compositor proxy running in the container. So interaction between windows works great with eye candy like transparency, etc... Each graphical application running from the container (whether it was launched from the ChromeOS launcher or the command line) appears on the shelf like any CromeOS (or Android) apps. And the integration works both ways: if you download a debian package, double clicking it will install it in the container, you can copy text from a ChromeOS window and paste it in a window from Linux. So much so that when you run a terminal, it really feels like a terminal of the underlying OS - and this is true for any apps.

!["Terminal"]({{ site.url }}/assets/images/chromeos-terminal.jpg)
*Linux (beta) terminal*

!["Linux app"]({{ site.url }}/assets/images/chromeos-code.jpg)
*Linux app, VSCode*

The virtual machine monitor (VMM) used to run the VM has been built specifically for ChromeOS. It's designed to run lightweight microVMs with a focus on security. From their [website](https://chromium.googlesource.com/chromiumos/platform/crosvm/+/master/README.md), "this component [...] runs untrusted operating systems along with virtualized devices. This only runs VMs through the Linux's KVM interface. What makes crosvm unique is a focus on safety within the programming language and a sandbox around the virtual devices to protect the kernel from attack in case of an exploit in the devices". This technology has been reused by Amazon when they built [firecracker](https://firecracker-microvm.github.io/), the VMM technology that is powering AWS Lambda. The two projects still collaborate through [rust-vmm](https://github.com/rust-vmm).

Having Linux running in a VM, within a container enables interesting features. You can snapshot it to backup/restore your Linux system, without ever touching ChromeOS. It's also possible to run multiple VMs and/or multiple containers. For instance on my Chromebook, I run the standard Debian 10 container and an Arch Linux container. The integration with ChromeOS works the same way from both containers: installed apps with a desktop entry are added to the ChromeOS launcher no matter which container they come from. The only thing that is necessary to make this work are the special [in-container tools](https://chromium.googlesource.com/chromiumos/containers/cros-container-guest-tools/) that Google built for the integration: the compositor proxy in particular but other tools as well such as the GTK theme to have windows look the same across the OS.

!["Multiple containers"]({{ site.url }}/assets/images/chromeos-2term.jpg)
*Multiple containers running on ChromeOS*

In the end, you get a pretty good system with a nice UI that can run side-by-side different distro of Linux, Android apps, webapps and that really secured. Soon the system will also be able to [run Windows apps](https://www.theverge.com/2020/7/31/21348963/google-chrome-os-windows-apps-chromebooks-features-interview) through roughly (from a high level perspective) the same technique as Linux, with yet another VM. Since everyhting is ChromeOS is sandboxed yet well integrated, it seems the future of the OS is to have a solid core that will be running a bunch of isolated environments through VMs. There are some rumors that ARC++ is evolving also towards that direction with [arcvm](https://9to5google.com/2019/05/24/chrome-os-android-apps-vm/) (see also [this](https://chromeunboxed.com/chrome-os-android-11-apps-arcvm-crostini/)).

